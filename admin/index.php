<?php

require_once("../../../map/meta_config.php");
require_once("../libs/funcs.php");
require_once("../libs/mail.php");

require 'Base/src/base.php';
spl_autoload_register( array( 'ezcBase', 'autoload' ) );

//spl_autoload_register( array( 'ezcBase', 'autoload' ) );

if (isset($_GET["opt"])) 
    {
        $opt = htmlspecialchars($_GET["opt"]);
    }
else
    {
        $opt = '0';
    }

if (isset($_POST["Submit"]))
    {
        $sub_opt = $_POST["Submit"];
        switch ($sub_opt)
            {
            case "add_customer":
                $company_name = test_input($_POST["company_name"]);
                $email = test_input($_POST["email"]);
                $contact_name = test_input($_POST["contact_name"]);
                $imed_reply = test_input($_POST["imed_reply"]);
                if (isset($_POST['imed_reply']))
                {
					$imed_reply = true;
				}
				else
				{
					$imed_reply = false;
				}
                $passwd =  generate_password();
                save_customer($company_name, $email, $contact_name, $passwd, $imed_reply);

                break;

            case "edit_customer":
                $company_name = test_input($_POST["company_name"]);
                $email = test_input($_POST["email"]);
                $contact_name = test_input($_POST["contact_name"]);
                $passwd = test_input($_POST['password']);
                $id = test_input($_POST['id']);
                if (isset($_POST['imed_reply']))
                {
					$imed_reply = true;
				}
				else
				{
					$imed_reply = false;
				}
				
                
                update_customer($id, $company_name, $email, $contact_name, $passwd, $imed_reply);
                break;
                             
            }
        
    }
    
if (isset($_POST["Invite"]))
{
	$company_name = test_input($_POST["company_name"]);
	$email = test_input($_POST["email"]);
	$contact_name = test_input($_POST["contact_name"]);
	$passwd = test_input($_POST['password']);
	$id = test_input($_POST['id']);
	$subject = "MAP questionnaire login details";
	
    $message = "<span style=\"font-family: Calibri, sans-serif; font-size:11pt\">";
    $message .= "<p>Please find below your company's login details to access the <b>Mindset Assessment Profile</b> questionnaire.</p>";
	//$message .= "<p>The same login ID should be used by everybody from your company that wishes to complete the survey.</p>";
    $message .= "<p>The link to the online survey is via <a href='map.meta-lucic.com?c_id=" . $passwd . "'>map.meta-lucid.com?c_id=" . $passwd ."</a></p><br/>";
	//$message .= "<p>The alternative link to the online survey is via <a href='map.meta-lucid.com'>map.meta-lucid.com</a></p>"; 
	//$message .= "<p>The ID is <b>" . $passwd . "</b></p>";
    $message .= "<p>Please inform participants that results will remain confidential and protected by data protection laws.</p>";
	$message .= "<p><i><u>This is an automated email generated by the MAP Server Application, please do not reply to this email</p></u></i><br/>";
    $message .= "<p>Kind regards</p><br/><br/>";
    $message .= "<p><b>MAP Team</b></p>";
    $message .= "<p><b><span style='color:#7bb00f'>Meta-LUCID Ltd</span></b></p>";
    $message .= "<p><img width='418' height='68' alt='ML Logo for email' src='http://map.meta-lucid.com/images/email_logo.png'></img></p>";
    $message .= "<p>e:&nbsp;<u><span style='color:blue'><a target='_blank' href='mailto:info@meta-lucid.com'>info@meta-lucid.com</a></span></u><br/>";
    $message .= "w:&nbsp;<u><span style='color:blue'><target='_blank' href='http:www.meta-lucid.com/'>www.meta-lucid.com</a></span></u></p>";
    $message .= "<p><b><span style='font-size:10.0pt;font-family:Arial, sans-serif;color:#74af27'>UK: Fountain Court, 2 Victoria Square, Victoria Street, St Albans, AL1 3TF</span></b><br/>";
    $message .= "<b><span style='font-size:10.0pt;font-family:Arial, sans-serif;color:#74af27'>US: 5847 San Felipe Street, Suite 1700, Houston, TX 77057</span></b></p>";
    $message .= "<p><span style='font-size:9.0pt;color:#646464'>This email and any attachments may be confidential or legally privileged. If you received this message in error or are not the intended recipient, you should destroy the email message and any attachments or copies, and you are prohibited from retaining, distributing, disclosing or using any information contained herein. Please inform us of the erroneous delivery by return email.</span></p>";
    $message .= "<p><span style='font-size:9.0pt; color:#646464'><br/><br/>Thank you for your cooperation</span></p>";
    $message .= "<p style='margin-left:36.0pt'><span style='font-size:14.0pt;font-fmaily:webdings;color:#76923c'>P </span><span style='font-size:10.0pt;font-family:Tahoma, sans-serif;color:#76923c'>Before printing this email please think about the environment</span></p>";
    
    


    $message .= "</span>";
        

	mail_invite($email, $subject, $message);
	$smarty->assign('message', $message);
	$smarty->assign('email', $email);
	$smarty->display('invite_sent.tpl');
	$opt = 1;
}
			

if (($opt == "home") or ($opt == '0'))
    {
        $smarty->assign('mypath', $_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"]);
        $smarty->assign('cust', list_customers());
        $smarty->assign('opt', 'home');
        $smarty->display('home.tpl');
    }
elseif ($opt == "comp_add")
    {     
        //$smarty->display('home.tpl');
        $smarty->display('add_customer.tpl');
    }
elseif ($opt == "comp_list")
    {
        $cust_id = $_GET["id"];
        $data = get_customer($cust_id);
        $smarty->assign('cust_data', $data);
        $smarty->display('show_customer.tpl');
    }
elseif ($opt == "edit_cust")
    {
        $cust_id =  $_GET["id"];
        $data = get_customer($cust_id);
         $smarty->assign('cust_data', $data);
        $smarty->display('edit_customer.tpl');
    }

elseif ($opt == "del_cust")
    {
        $cust_id =  $_GET["id"];
        delete_customer($cust_id);
        $smarty->assign('mypath', $_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"]);
        $smarty->assign('cust', list_customers());
        $smarty->assign('opt', 'home');
        $smarty->display('home.tpl');      
    }
elseif ($opt == "user_list")
    {
        $cust_id = $_GET["id"];
        $data = get_users($cust_id);
        
        $smarty->assign('user_data', $data);
        $data2 = get_customer($cust_id);
        $smarty->assign('cust_name', $data2['name']);
        $smarty->display('show_users.tpl');
    }
elseif ($opt == "comp_graph")
    {
        $smarty->assign('cust', list_customers());
        $smarty->display('cust_graph_list.tpl');
    }
elseif ($opt == 'show_bar_graph')
    {
        $cust_id = $_GET["id"];
        
        $cust_details = get_customer($cust_id);
        
        $data = cust_graph_data($cust_id);
       

        $graph = new ezcGraphPieChart();
        //$graph->palette = new ezcGraphPaletteBlack(); 
        //$graph = new ezcGraphBarChart();
        $graph->title = $cust_details['name'];
        $graph->renderer->options->moveOut = .2;
$graph->renderer->options->pieChartOffset = 63;
$graph->renderer->options->pieChartGleam = .3;
$graph->renderer->options->pieChartGleamColor = '#FFFFFF';
$graph->renderer->options->pieChartGleamBorder = 2;
$graph->renderer->options->pieChartShadowSize = 3;
$graph->renderer->options->pieChartShadowColor = '#000000';
$graph->renderer->options->legendSymbolGleam = .5;
$graph->renderer->options->legendSymbolGleamSize = .9;
$graph->renderer->options->legendSymbolGleamColor = '#FFFFFF';
$graph->renderer->options->pieChartSymbolColor = '#BABDB688'; 


        $graph->data['dd'] = new ezcGraphArrayDataSet($data);
        $graph->renderer = new ezcGraphRenderer3d();
        $graph->rendertoOutput( 800, 500, 'graph_test.svg');

    }
        
?>


